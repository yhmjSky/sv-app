# GitLab CI/CD é…ç½®ï¼ˆç²¾ç®€ç‰ˆï¼‰
# ä»…æ‰§è¡Œè‡ªåŠ¨æ•°æ®åº“è®¾ç½®ä¸é…ç½®æäº¤ï¼Œä¸è¿›è¡Œä¾èµ–å®‰è£…ä¸æ„å»º

stages:
  - setup

variables:
  NODE_VERSION: "20"
  GIT_DEPTH: 1
  GIT_STRATEGY: clone

# å•ä¸€ä½œä¸šï¼šæŒ‰éœ€ï¼ˆschedule/web/api/triggerï¼‰æ‰§è¡Œæ•°æ®åº“è‡ªåŠ¨è®¾ç½®
database-setup:
  stage: setup
  image: node:${NODE_VERSION}
  timeout: 30m
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $CI_PIPELINE_SOURCE == "web"
    - if: $CI_PIPELINE_SOURCE == "api"
    - if: $CI_PIPELINE_SOURCE == "trigger"
  variables:
    SETUP_YEAR: ""
    SETUP_MONTH: ""
    DRY_RUN: "false"
    # å¯é€‰ï¼šè‡ªå®šä¹‰ GitLab HTTP åŸºç¡€åœ°å€ï¼ˆåŒ…å«åè®®å’Œç«¯å£ï¼‰ï¼Œä¾‹å¦‚ http://192.168.8.210:6080
    GITLAB_HTTP_URL: ""
  before_script:
    - echo "ğŸš€ Starting database setup job..."
    - echo "Node.js version:" && node --version
    - echo "Git version:" && git --version
    # åŸºæœ¬ç¯å¢ƒå˜é‡æ ¡éªŒï¼ˆä¸ä¾èµ– npm åŒ…ï¼‰
    - |
      if [ -z "$CLOUDFLARE_ACCOUNT_ID" ]; then
        echo "âŒ CLOUDFLARE_ACCOUNT_ID is not set"; exit 1; fi
    - |
      if [ -z "$CLOUDFLARE_API_TOKEN" ]; then
        echo "âŒ CLOUDFLARE_API_TOKEN is not set"; exit 1; fi
    # é…ç½® Git èº«ä»½
    - git config --global user.email "gitlab-ci@${CI_PROJECT_NAMESPACE}.gitlab.local"
    - git config --global user.name "GitLab CI"
  script:
    - |
      echo "ğŸ”§ Building arguments..."
      ARGS=""
      if [ -n "$SETUP_YEAR" ]; then ARGS="$ARGS --year $SETUP_YEAR"; fi
      if [ -n "$SETUP_MONTH" ]; then ARGS="$ARGS --month $SETUP_MONTH"; fi
      if [ "$DRY_RUN" = "true" ]; then ARGS="$ARGS --dry-run"; fi
      echo "â†’ node scripts/auto-setup-database.js $ARGS"
      node scripts/auto-setup-database.js $ARGS
    - |
      echo "ğŸ” Checking for wrangler.jsonc changes..."
      if git diff --quiet -- wrangler.jsonc; then
        echo "â„¹ï¸ No changes in wrangler.jsonc"; echo "HAS_CHANGES=false" > setup.env;
      else
        echo "âœ… Configuration changes detected"; echo "HAS_CHANGES=true" > setup.env;
        git add wrangler.jsonc
        if [ "$DRY_RUN" = "true" ]; then
          echo "ğŸ” Dry run mode - skip commit";
        else
          git commit -m "ğŸ¤– Auto-update D1 binding for $(date +'%Y-%m')" -m "Automated database configuration update" || echo "âš ï¸ Nothing to commit"

          # æ¨é€æ›´æ”¹ï¼ˆä¼˜å…ˆä½¿ç”¨ Personal/Project Access Token: GITLAB_TOKENï¼‰ï¼Œå¤±è´¥ä¸ä½¿ä½œä¸šå¤±è´¥
          # å…¼å®¹è‡ªç­¾åæˆ–é 443 ç«¯å£ï¼Œé€šè¿‡ HTTP é¿å… TLS é—®é¢˜
          BASE_URL="$GITLAB_HTTP_URL"
          if [ -z "$BASE_URL" ]; then
            # å¦‚æœªæ˜¾å¼æŒ‡å®šï¼Œåˆ™é»˜è®¤ä½¿ç”¨ CI_SERVER_HOST çš„ 6080 ç«¯å£ï¼ˆæŒ‰ä½ çš„ç¯å¢ƒç¤ºä¾‹ï¼‰
            BASE_URL="http://${CI_SERVER_HOST}:6080"
          fi

          REPO_PATH="${CI_PROJECT_PATH}.git"

          if [ -n "$GITLAB_TOKEN" ]; then
            echo "ğŸ” Using GITLAB_TOKEN (oauth2) to push"
            git push "http://oauth2:${GITLAB_TOKEN}@${BASE_URL#http://}/${REPO_PATH}" HEAD:${CI_COMMIT_REF_NAME} -o ci.skip || echo "âš ï¸ æ¨é€å¤±è´¥ï¼ˆoauth2ï¼‰ï¼Œå¯èƒ½æ— æƒé™æˆ–ç½‘ç»œå¼‚å¸¸"
          else
            echo "ğŸ” Using CI_JOB_TOKEN to push"
            git push "http://gitlab-ci-token:${CI_JOB_TOKEN}@${BASE_URL#http://}/${REPO_PATH}" HEAD:${CI_COMMIT_REF_NAME} -o ci.skip || echo "âš ï¸ æ¨é€å¤±è´¥ï¼ˆCI_JOB_TOKENï¼‰ï¼Œå¯èƒ½æ— æƒé™æˆ–ç½‘ç»œå¼‚å¸¸"
          fi
        fi
      fi
  after_script:
    - cat setup.env || true
  # æ— ç¼“å­˜ã€æ—  artifactsï¼Œé¿å… Runner/Coordinator 500 é”™è¯¯
  cache: {}
