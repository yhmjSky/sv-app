# GitLab CI/CD é…ç½®ï¼ˆç²¾ç®€ç‰ˆï¼‰
# ä»…æ‰§è¡Œè‡ªåŠ¨æ•°æ®åº“è®¾ç½®ä¸é…ç½®æäº¤ï¼Œä¸è¿›è¡Œä¾èµ–å®‰è£…ä¸æ„å»º

stages:
  - setup

variables:
  NODE_VERSION: "20"
  GIT_DEPTH: 1
  GIT_STRATEGY: clone

# å•ä¸€ä½œä¸šï¼šæŒ‰éœ€ï¼ˆschedule/web/api/triggerï¼‰æ‰§è¡Œæ•°æ®åº“è‡ªåŠ¨è®¾ç½®
database-setup:
  stage: setup
  image: node:${NODE_VERSION}
  timeout: 30m
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $CI_PIPELINE_SOURCE == "web"
    - if: $CI_PIPELINE_SOURCE == "api"
    - if: $CI_PIPELINE_SOURCE == "trigger"
  variables:
    SETUP_YEAR: ""
    SETUP_MONTH: ""
    DRY_RUN: "false"
  before_script:
    - echo "ğŸš€ Starting database setup job..."
    - echo "Node.js version:" && node --version
    - echo "Git version:" && git --version
    # åŸºæœ¬ç¯å¢ƒå˜é‡æ ¡éªŒï¼ˆä¸ä¾èµ– npm åŒ…ï¼‰
    - |
      if [ -z "$CLOUDFLARE_ACCOUNT_ID" ]; then
        echo "âŒ CLOUDFLARE_ACCOUNT_ID is not set"; exit 1; fi
    - |
      if [ -z "$CLOUDFLARE_API_TOKEN" ]; then
        echo "âŒ CLOUDFLARE_API_TOKEN is not set"; exit 1; fi
    # é…ç½® Git èº«ä»½
    - git config --global user.email "gitlab-ci@${CI_PROJECT_NAMESPACE}.gitlab.local"
    - git config --global user.name "GitLab CI"
  script:
    - |
      echo "ğŸ”§ Building arguments..."
      ARGS=""
      if [ -n "$SETUP_YEAR" ]; then ARGS="$ARGS --year $SETUP_YEAR"; fi
      if [ -n "$SETUP_MONTH" ]; then ARGS="$ARGS --month $SETUP_MONTH"; fi
      if [ "$DRY_RUN" = "true" ]; then ARGS="$ARGS --dry-run"; fi
      echo "â†’ node scripts/auto-setup-database.js $ARGS"
      node scripts/auto-setup-database.js $ARGS
    - |
      echo "ğŸ” Checking for wrangler.jsonc changes..."
      if git diff --quiet -- wrangler.jsonc; then
        echo "â„¹ï¸ No changes in wrangler.jsonc"; echo "HAS_CHANGES=false" > setup.env;
      else
        echo "âœ… Configuration changes detected"; echo "HAS_CHANGES=true" > setup.env;
        git add wrangler.jsonc
        if [ "$DRY_RUN" = "true" ]; then
          echo "ğŸ” Dry run mode - skip commit";
        else
          git commit -m "ğŸ¤– Auto-update D1 binding for $(date +'%Y-%m')" -m "Automated database configuration update"
          # ä½¿ç”¨ Job Token æ¨é€
          if [ -n "$CI_SERVER_HOST" ] && [ -n "$CI_PROJECT_PATH" ]; then
            git remote set-url origin https://gitlab-ci-token:${CI_JOB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git
          fi
          git push origin HEAD:${CI_COMMIT_REF_NAME} || (echo "âŒ Failed to push changes" && exit 1)
        fi
      fi
  after_script:
    - cat setup.env || true
  # æ— ç¼“å­˜ã€æ—  artifactsï¼Œé¿å… Runner/Coordinator 500 é”™è¯¯
  cache: {}
