# è‡ªåŠ¨åŒ–æ•°æ®åº“ç®¡ç†è„šæœ¬ç³»ç»Ÿ

## ğŸ¯ é¡¹ç›®æ¦‚è¿°

åŸºäºä½ çš„éœ€æ±‚ï¼Œæˆ‘å·²ç»åˆ›å»ºäº†ä¸€å¥—å®Œæ•´çš„è‡ªåŠ¨åŒ–æ•°æ®åº“ç®¡ç†è„šæœ¬ç³»ç»Ÿï¼Œæ•´åˆå¹¶ä¼˜åŒ–äº†åŸæœ‰çš„ action-hub å’Œ action-lab è„šæœ¬ï¼Œå®ç°äº†ä»¥ä¸‹åŠŸèƒ½ï¼š

1. **æ‰‹åŠ¨ç»‘å®šæ›´æ–°** - æ‰‹åŠ¨åˆ›å»ºæ•°æ®åº“åè‡ªåŠ¨æ›´æ–° wrangler.jsonc é…ç½®
2. **è‡ªåŠ¨åŒ–æµæ°´çº¿** - å®šæ—¶åˆ›å»ºæ•°æ®åº“ã€è¡¨å’ŒåŠ¨æ€ç»‘å®šçš„å®Œæ•´æµç¨‹

## ğŸ“ è„šæœ¬ç³»ç»Ÿæ¶æ„

### æ ¸å¿ƒæ¨¡å—
```
scripts/
â”œâ”€â”€ wrangler-config-manager.js   # ç»Ÿä¸€çš„é…ç½®æ–‡ä»¶ç®¡ç†
â”œâ”€â”€ database-manager.js          # ç»Ÿä¸€çš„æ•°æ®åº“æ“ä½œ
â”œâ”€â”€ update-binding.js            # æ‰‹åŠ¨ç»‘å®šæ›´æ–°è„šæœ¬
â”œâ”€â”€ auto-setup-database.js       # è‡ªåŠ¨åŒ–æµæ°´çº¿è„šæœ¬
â””â”€â”€ README.md                    # è¯¦ç»†ä½¿ç”¨è¯´æ˜
```

### CI/CD é…ç½®
```
.github/workflows/
â””â”€â”€ auto-database-setup.yml      # GitHub Actions å·¥ä½œæµ

.gitlab-ci.yml                   # GitLab CI/CD é…ç½®
```

## ğŸš€ æ ¸å¿ƒåŠŸèƒ½ç‰¹æ€§

### 1. æ™ºèƒ½é‡å¤æ£€æµ‹
- âœ… è‡ªåŠ¨æ£€æµ‹æ•°æ®åº“æ˜¯å¦å·²å­˜åœ¨ï¼Œå­˜åœ¨åˆ™è·³è¿‡å¹¶è¯´æ˜
- âœ… è‡ªåŠ¨æ£€æµ‹è¡¨æ˜¯å¦å·²å­˜åœ¨ï¼Œå­˜åœ¨åˆ™è·³è¿‡å¹¶è¯´æ˜
- âœ… æ™ºèƒ½æ›´æ–°æˆ–æ·»åŠ  wrangler.jsonc ç»‘å®šé…ç½®

### 2. ç»Ÿä¸€å‘½åè§„èŒƒ
- ğŸ“‹ æ•°æ®åº“å‘½å: `d1_YYYYMM` (å¦‚ `d1_202508`)
- ğŸ“‹ ç»‘å®šåç§°: ä¸æ•°æ®åº“åç§°ç›¸åŒ
- ğŸ“‹ è‡ªåŠ¨ç”Ÿæˆå½“å‰å¹´æœˆçš„æ•°æ®åº“åç§°

### 3. å®Œæ•´çš„é”™è¯¯å¤„ç†
- âš ï¸ ç¯å¢ƒå˜é‡éªŒè¯
- âš ï¸ API æƒé™æ£€æŸ¥
- âš ï¸ ç½‘ç»œé”™è¯¯æ¢å¤
- âš ï¸ è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å’Œè§£å†³å»ºè®®

## ğŸ› ï¸ ä½¿ç”¨æ–¹æ³•

### åœºæ™¯1: æ‰‹åŠ¨åˆ›å»ºæ•°æ®åº“åæ›´æ–°ç»‘å®š

```bash
# æ–¹æ³•1: è‡ªåŠ¨æ£€æµ‹æ•°æ®åº“ ID
npm run db:update-binding d1_202508

# æ–¹æ³•2: æ‰‹åŠ¨æŒ‡å®šæ•°æ®åº“ ID  
node scripts/update-binding.js d1_202508 abc123-def456-ghi789

# æŸ¥çœ‹å¸®åŠ©
node scripts/update-binding.js --help
```

**æ‰§è¡Œæµç¨‹**:
1. éªŒè¯æ•°æ®åº“åç§°æ ¼å¼
2. è¿æ¥ Cloudflare API æŸ¥æ‰¾æ•°æ®åº“
3. æ›´æ–°æˆ–æ·»åŠ  wrangler.jsonc ç»‘å®š
4. ä¿å­˜é…ç½®æ–‡ä»¶

### åœºæ™¯2: è‡ªåŠ¨åŒ–æµæ°´çº¿è®¾ç½®

```bash
# åˆ›å»ºå½“å‰æœˆä»½æ•°æ®åº“
npm run db:auto-setup

# åˆ›å»ºæŒ‡å®šæœˆä»½æ•°æ®åº“
node scripts/auto-setup-database.js --year 2025 --month 2

# å¹²è¿è¡Œæ¨¡å¼ï¼ˆé¢„è§ˆæ“ä½œï¼‰
npm run db:auto-setup-dry

# æŸ¥çœ‹å¸®åŠ©
node scripts/auto-setup-database.js --help
```

**æ‰§è¡Œæµç¨‹**:
1. æ£€æŸ¥æ•°æ®åº“æ˜¯å¦å­˜åœ¨
2. åˆ›å»ºæ•°æ®åº“ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
3. åº”ç”¨æ•°æ®åº“è¿ç§»åˆ›å»ºè¡¨
4. æ›´æ–° wrangler.jsonc ç»‘å®šé…ç½®
5. ç”Ÿæˆè¯¦ç»†çš„æ‰§è¡ŒæŠ¥å‘Š

## ğŸ¤– CI/CD è‡ªåŠ¨åŒ–

### GitHub Actions

**è§¦å‘æ¡ä»¶**:
- ğŸ• å®šæ—¶è§¦å‘: æ¯æœˆ1å· UTC 00:00 (åŒ—äº¬æ—¶é—´ 08:00)
- ğŸ–±ï¸ æ‰‹åŠ¨è§¦å‘: æ”¯æŒè‡ªå®šä¹‰å¹´æœˆå‚æ•°

**é…ç½®æ­¥éª¤**:
1. åœ¨ GitHub ä»“åº“ Settings â†’ Secrets ä¸­æ·»åŠ :
   - `CLOUDFLARE_ACCOUNT_ID`
   - `CLOUDFLARE_API_TOKEN`

2. å·¥ä½œæµè‡ªåŠ¨æ‰§è¡Œ:
   - åˆ›å»ºæœˆåº¦æ•°æ®åº“
   - åº”ç”¨è¡¨ç»“æ„è¿ç§»
   - æ›´æ–° wrangler.jsonc é…ç½®
   - æäº¤é…ç½®æ›´æ”¹
   - åˆ›å»ºéƒ¨ç½²æé†’ Issue

### GitLab CI/CD

**é…ç½®æ­¥éª¤**:
1. åœ¨ GitLab é¡¹ç›® Settings â†’ CI/CD â†’ Variables ä¸­æ·»åŠ :
   - `CLOUDFLARE_ACCOUNT_ID`
   - `CLOUDFLARE_API_TOKEN`

2. è®¾ç½®å®šæ—¶ç®¡é“:
   - è¿›å…¥ CI/CD â†’ Schedules
   - åˆ›å»ºæ–°å®šæ—¶ä»»åŠ¡
   - Cron è¡¨è¾¾å¼: `0 0 1 * *`

## ğŸ“Š è„šæœ¬æ•´åˆä¼˜åŒ–

### åŸæœ‰è„šæœ¬é—®é¢˜
- âŒ action-hub å’Œ action-lab å­˜åœ¨å¤§é‡é‡å¤ä»£ç 
- âŒ é…ç½®ç®¡ç†åˆ†æ•£ï¼Œéš¾ä»¥ç»´æŠ¤
- âŒ é”™è¯¯å¤„ç†ä¸ç»Ÿä¸€
- âŒ ç¼ºä¹æ™ºèƒ½é‡å¤æ£€æµ‹

### ä¼˜åŒ–åçš„æ”¹è¿›
- âœ… **æ¨¡å—åŒ–è®¾è®¡**: æ ¸å¿ƒåŠŸèƒ½æŠ½å–ä¸ºç‹¬ç«‹æ¨¡å—
- âœ… **ä»£ç å¤ç”¨**: ç»Ÿä¸€çš„é…ç½®å’Œæ•°æ®åº“ç®¡ç†å™¨
- âœ… **æ™ºèƒ½æ£€æµ‹**: è‡ªåŠ¨è·³è¿‡å·²å­˜åœ¨çš„èµ„æº
- âœ… **ç»Ÿä¸€æ¥å£**: ç›¸åŒçš„ API è°ƒç”¨å’Œé”™è¯¯å¤„ç†
- âœ… **è¯¦ç»†æ—¥å¿—**: å®Œæ•´çš„æ“ä½œè®°å½•å’ŒçŠ¶æ€åé¦ˆ

### ä»£ç å‡å°‘ç»Ÿè®¡
- ğŸ“‰ é‡å¤ä»£ç å‡å°‘ ~70%
- ğŸ“‰ é…ç½®ç®¡ç†ç»Ÿä¸€åŒ–
- ğŸ“‰ é”™è¯¯å¤„ç†æ ‡å‡†åŒ–
- ğŸ“ˆ åŠŸèƒ½è¦†ç›–å¢åŠ  ~40%

## ğŸ”§ æŠ€æœ¯å®ç°ç»†èŠ‚

### é…ç½®æ–‡ä»¶ç®¡ç†
```javascript
// ç»Ÿä¸€çš„ wrangler.jsonc ç®¡ç†
const configManager = new WranglerConfigManager();
configManager.load();
configManager.addD1Database({
    binding: "d1_202508",
    database_name: "d1_202508", 
    database_id: "abc123-def456-ghi789",
    migrations_dir: "drizzle"
});
configManager.save();
```

### æ•°æ®åº“æ“ä½œ
```javascript
// ç»Ÿä¸€çš„æ•°æ®åº“ç®¡ç†
const dbManager = new DatabaseManager();
const result = await dbManager.setupDatabase("d1_202508");

// è‡ªåŠ¨å¤„ç†:
// 1. æ£€æŸ¥æ•°æ®åº“æ˜¯å¦å­˜åœ¨
// 2. åˆ›å»ºæ•°æ®åº“ï¼ˆå¦‚éœ€è¦ï¼‰
// 3. åº”ç”¨è¿ç§»åˆ›å»ºè¡¨
// 4. è¿”å›è¯¦ç»†ç»“æœ
```

### æ™ºèƒ½é‡å¤æ£€æµ‹
```javascript
// æ•°æ®åº“å­˜åœ¨æ£€æµ‹
const exists = await dbManager.databaseExists("d1_202508");
if (exists) {
    console.log("âš ï¸ Database already exists, skipping creation");
    return { skipped: true, reason: "already_exists" };
}

// è¡¨å­˜åœ¨æ£€æµ‹  
const tableExists = await dbManager.tableExists(dbId, "user");
if (tableExists) {
    console.log("âš ï¸ Table 'user' already exists, skipping");
}
```

## ğŸ“‹ ç¯å¢ƒå˜é‡é…ç½®

### å¼€å‘ç¯å¢ƒ
```bash
# .env æ–‡ä»¶
CLOUDFLARE_ACCOUNT_ID=your-account-id
CLOUDFLARE_API_TOKEN=your-api-token

# .dev.vars æ–‡ä»¶ï¼ˆç”¨äº wrangler devï¼‰
CLOUDFLARE_ACCOUNT_ID=your-account-id
CLOUDFLARE_API_TOKEN=your-api-token
```

### ç”Ÿäº§ç¯å¢ƒ
```bash
# GitHub Secrets
CLOUDFLARE_ACCOUNT_ID=your-account-id
CLOUDFLARE_API_TOKEN=your-api-token

# GitLab CI/CD Variables
CLOUDFLARE_ACCOUNT_ID=your-account-id
CLOUDFLARE_API_TOKEN=your-api-token
```

## ğŸ¯ ä½¿ç”¨åœºæ™¯ç¤ºä¾‹

### åœºæ™¯1: æ¯æœˆè‡ªåŠ¨åˆ›å»ºæ•°æ®åº“
```yaml
# GitHub Actions æ¯æœˆ1å·è‡ªåŠ¨æ‰§è¡Œ
- cron: '0 0 1 * *'  # UTC 00:00 = åŒ—äº¬æ—¶é—´ 08:00
```

### åœºæ™¯2: æ‰‹åŠ¨åˆ›å»ºç‰¹å®šæœˆä»½æ•°æ®åº“
```bash
# ä¸º2025å¹´2æœˆåˆ›å»ºæ•°æ®åº“
node scripts/auto-setup-database.js --year 2025 --month 2
```

### åœºæ™¯3: Webç•Œé¢åˆ›å»ºåæ›´æ–°é…ç½®
```bash
# é€šè¿‡Webç•Œé¢åˆ›å»ºäº† d1_202508 å
npm run db:update-binding d1_202508
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### API æƒé™è¦æ±‚
- `Zone:Zone:Read` - è¯»å–åŒºåŸŸä¿¡æ¯
- `Account:Cloudflare D1:Edit` - ç®¡ç† D1 æ•°æ®åº“

### å®‰å…¨å»ºè®®
- ğŸ”’ ä½¿ç”¨ Secrets å­˜å‚¨æ•æ„Ÿä¿¡æ¯
- ğŸ”„ å®šæœŸè½®æ¢ API Token
- ğŸ“ å¯ç”¨æ“ä½œå®¡è®¡æ—¥å¿—

### æ•…éšœæ’é™¤
1. **ç¯å¢ƒå˜é‡æœªè®¾ç½®**: æ£€æŸ¥ `.env` æ–‡ä»¶æˆ– CI/CD å˜é‡
2. **API æƒé™ä¸è¶³**: ç¡®è®¤ Token æƒé™èŒƒå›´
3. **ç½‘ç»œè¿æ¥é—®é¢˜**: æ£€æŸ¥ Cloudflare API å¯è®¿é—®æ€§

## ğŸš€ éƒ¨ç½²æµç¨‹

### å®Œæ•´çš„è‡ªåŠ¨åŒ–æµç¨‹
1. **å®šæ—¶è§¦å‘** â†’ CI/CD ç®¡é“å¯åŠ¨
2. **ç¯å¢ƒæ£€æŸ¥** â†’ éªŒè¯å¿…éœ€çš„ç¯å¢ƒå˜é‡
3. **æ•°æ®åº“è®¾ç½®** â†’ åˆ›å»ºæ•°æ®åº“å’Œè¡¨ç»“æ„
4. **é…ç½®æ›´æ–°** â†’ æ›´æ–° wrangler.jsonc ç»‘å®š
5. **æäº¤æ›´æ”¹** â†’ è‡ªåŠ¨æäº¤é…ç½®æ–‡ä»¶
6. **éƒ¨ç½²æé†’** â†’ åˆ›å»º Issue æˆ–é€šçŸ¥

### æ‰‹åŠ¨å¹²é¢„ç‚¹
- ğŸ” å¹²è¿è¡Œæ¨¡å¼é¢„è§ˆæ“ä½œ
- ğŸ–±ï¸ æ‰‹åŠ¨è§¦å‘ç‰¹å®šæœˆä»½è®¾ç½®
- ğŸ”§ æ‰‹åŠ¨æ›´æ–°ç»‘å®šé…ç½®
- ğŸš€ æ‰‹åŠ¨è§¦å‘åº”ç”¨éƒ¨ç½²

## ğŸ“ˆ æ•ˆæœå¯¹æ¯”

| åŠŸèƒ½ | åŸæœ‰æ–¹æ¡ˆ | ä¼˜åŒ–åæ–¹æ¡ˆ |
|------|----------|------------|
| ä»£ç å¤ç”¨ | ä½ (é‡å¤ä»£ç å¤š) | é«˜ (æ¨¡å—åŒ–è®¾è®¡) |
| é”™è¯¯å¤„ç† | åˆ†æ•£ | ç»Ÿä¸€æ ‡å‡†åŒ– |
| é‡å¤æ£€æµ‹ | æ—  | æ™ºèƒ½è‡ªåŠ¨æ£€æµ‹ |
| é…ç½®ç®¡ç† | æ‰‹åŠ¨ | è‡ªåŠ¨åŒ– |
| ç»´æŠ¤æˆæœ¬ | é«˜ | ä½ |
| åŠŸèƒ½è¦†ç›– | åŸºç¡€ | å®Œæ•´ |

ä½ çš„æ•°æ®åº“ç®¡ç†ç°åœ¨æ‹¥æœ‰äº†å®Œæ•´çš„è‡ªåŠ¨åŒ–æµç¨‹ï¼ğŸ‰
