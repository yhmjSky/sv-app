name: Auto Database Setup

on:
  # å®šæ—¶è§¦å‘ - æ¯æœˆ1å· UTC 00:00 (åŒ—äº¬æ—¶é—´ 08:00)
  schedule:
    - cron: '0 0 1 * *'

  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      year:
        description: 'Target year (YYYY)'
        required: false
        default: ''
        type: string
      month:
        description: 'Target month (MM)'
        required: false
        default: ''
        type: string
      dry_run:
        description: 'Dry run mode'
        required: false
        default: false
        type: boolean

# çŽ¯å¢ƒå˜é‡
env:
  NODE_VERSION: '18'

# æƒé™è®¾ç½®
permissions:
  contents: write
  issues: write
  pull-requests: read

jobs:
  # çŽ¯å¢ƒéªŒè¯ä»»åŠ¡
  validate:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    outputs:
      env-valid: ${{ steps.validate.outputs.valid }}

    steps:
      - name: Validate environment variables
        id: validate
        run: |
          echo "ðŸ” Validating required environment variables..."

          if [ -z "${{ secrets.CLOUDFLARE_ACCOUNT_ID }}" ]; then
            echo "âŒ CLOUDFLARE_ACCOUNT_ID secret is not set"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          if [ -z "${{ secrets.CLOUDFLARE_API_TOKEN }}" ]; then
            echo "âŒ CLOUDFLARE_API_TOKEN secret is not set"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "âœ… All required environment variables are set"
          echo "valid=true" >> $GITHUB_OUTPUT

  # ä¸»è¦çš„æ•°æ®åº“è®¾ç½®ä»»åŠ¡
  setup-database:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: validate
    if: needs.validate.outputs.env-valid == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # ä½¿ç”¨ PAT ä»¥ä¾¿æŽ¨é€æ›´æ”¹
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          echo "ðŸ“¦ Installing dependencies..."
          npm ci

      - name: Setup environment variables
        run: |
          echo "ðŸ”§ Setting up environment variables..."
          echo "CLOUDFLARE_ACCOUNT_ID=${{ secrets.CLOUDFLARE_ACCOUNT_ID }}" >> $GITHUB_ENV
          echo "CLOUDFLARE_API_TOKEN=${{ secrets.CLOUDFLARE_API_TOKEN }}" >> $GITHUB_ENV
      
      - name: Run database setup
        id: setup
        run: |
          echo "ðŸ¤– Starting automated database setup..."

          # æž„å»ºå‚æ•°
          ARGS=""

          if [ -n "${{ github.event.inputs.year }}" ]; then
            ARGS="$ARGS --year ${{ github.event.inputs.year }}"
            echo "Using custom year: ${{ github.event.inputs.year }}"
          fi

          if [ -n "${{ github.event.inputs.month }}" ]; then
            ARGS="$ARGS --month ${{ github.event.inputs.month }}"
            echo "Using custom month: ${{ github.event.inputs.month }}"
          fi

          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            ARGS="$ARGS --dry-run"
            echo "Running in dry-run mode"
          fi

          echo "Setup arguments: $ARGS"
          echo ""

          # æ‰§è¡Œæ•°æ®åº“è®¾ç½®
          if ! node scripts/auto-setup-database.js $ARGS; then
            echo "âŒ Database setup failed"
            echo "setup-success=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "setup-success=true" >> $GITHUB_OUTPUT
      
      - name: Check for changes
        id: changes
        if: steps.setup.outputs.setup-success == 'true'
        run: |
          echo "ðŸ” Checking for configuration changes..."

          if git diff --quiet; then
            echo "â„¹ï¸ No configuration changes detected"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… Configuration changes detected"
            echo "has_changes=true" >> $GITHUB_OUTPUT

            echo "ðŸ“‹ Changes made:"
            git diff --name-only
            echo "ðŸ“ Diff summary:"
            git diff --stat
          fi

      - name: Commit and push changes
        if: steps.changes.outputs.has_changes == 'true' && github.event.inputs.dry_run != true
        run: |
          echo "ðŸ”„ Committing configuration changes..."

          # é…ç½® Git
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # éªŒè¯æ–‡ä»¶å­˜åœ¨
          if [ ! -f wrangler.jsonc ]; then
            echo "âŒ wrangler.jsonc file not found"
            exit 1
          fi

          # æäº¤æ›´æ”¹
          git add wrangler.jsonc

          # æ£€æŸ¥æ˜¯å¦æœ‰å†…å®¹è¦æäº¤
          if git diff --cached --quiet; then
            echo "âš ï¸ No changes to commit"
          else
            git commit -m "ðŸ¤– Auto-update database binding for $(date +'%Y-%m')" \
                       -m "Automated database configuration update" \
                       -m "Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

            if git push; then
              echo "âœ… Configuration changes committed and pushed successfully"
            else
              echo "âŒ Failed to push changes"
              exit 1
            fi
          fi
      
      - name: Create deployment issue
        if: steps.changes.outputs.has_changes == 'true' && github.event.inputs.dry_run != true
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const date = new Date();
            const year = github.event.inputs.year || date.getFullYear();
            const month = github.event.inputs.month || (date.getMonth() + 1);
            const yearMonth = `${year}-${String(month).padStart(2, '0')}`;
            const databaseName = `d1_${year}${String(month).padStart(2, '0')}`;

            try {
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ðŸš€ Deploy database setup for ${yearMonth}`,
                body: `## ðŸ¤– æ•°æ®åº“è‡ªåŠ¨è®¾ç½®å®Œæˆ

            æ–°çš„æ•°æ®åº“é…ç½®å·²è‡ªåŠ¨åˆ›å»ºå¹¶æäº¤åˆ°ä»“åº“ã€‚

            ### ðŸ“‹ è¯¦æƒ…
            - **æ•°æ®åº“åç§°**: \`${databaseName}\`
            - **é…ç½®æ–‡ä»¶**: \`wrangler.jsonc\` å·²æ›´æ–°
            - **æäº¤æ—¶é—´**: ${new Date().toISOString()}
            - **å·¥ä½œæµ**: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ### ðŸš€ ä¸‹ä¸€æ­¥æ“ä½œ
            è¯·æ‰‹åŠ¨è§¦å‘éƒ¨ç½²æµç¨‹ä»¥åº”ç”¨æ–°çš„æ•°æ®åº“é…ç½®ï¼š

            1. æ£€æŸ¥é…ç½®æ›´æ”¹æ˜¯å¦æ­£ç¡®
            2. è§¦å‘éƒ¨ç½²å·¥ä½œæµ
            3. éªŒè¯æ–°æ•°æ®åº“åŠŸèƒ½

            ### ðŸ”— ç›¸å…³é“¾æŽ¥
            - [æŸ¥çœ‹æœ€æ–°æäº¤](${{ github.server_url }}/${{ github.repository }}/commits/${{ github.ref_name }})
            - [éƒ¨ç½²åº”ç”¨](${{ github.server_url }}/${{ github.repository }}/actions)
            - [æ•°æ®åº“ç®¡ç†](${{ github.server_url }}/${{ github.repository }}/blob/${{ github.ref_name }}/wrangler.jsonc)

            ---
            *æ­¤ Issue ç”± GitHub Actions è‡ªåŠ¨åˆ›å»º*`,
                labels: ['database', 'auto-setup', 'deployment', 'automation']
              });

              console.log(\`âœ… Created deployment issue: #\${issue.data.number}\`);
            } catch (error) {
              console.error('âŒ Failed to create issue:', error);
              // ä¸è¦å› ä¸ºåˆ›å»º Issue å¤±è´¥è€Œè®©æ•´ä¸ªå·¥ä½œæµå¤±è´¥
            }
      
      - name: Summary
        if: always()
        run: |
          echo "## ðŸ¤– Auto Database Setup Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Execution Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Dry Run**: ${{ github.event.inputs.dry_run || false }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Year**: ${{ github.event.inputs.year || 'Current' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Month**: ${{ github.event.inputs.month || 'Current' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Setup Success**: ${{ steps.setup.outputs.setup-success || 'false' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Changes Made**: ${{ steps.changes.outputs.has_changes || 'false' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ðŸ“‹ Results" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.setup.outputs.setup-success }}" = "true" ]; then
            if [ "${{ steps.changes.outputs.has_changes }}" = "true" ]; then
              if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
                echo "ðŸ” **Dry run completed** - No actual changes were made" >> $GITHUB_STEP_SUMMARY
              else
                echo "âœ… **Database configuration updated successfully!**" >> $GITHUB_STEP_SUMMARY
                echo "- Configuration file updated" >> $GITHUB_STEP_SUMMARY
                echo "- Changes committed and pushed" >> $GITHUB_STEP_SUMMARY
                echo "- Deployment issue created" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "â„¹ï¸ **No changes needed** - Database already configured correctly" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ **Database setup failed** - Check the logs for details" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "- [Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "- [Repository](${{ github.server_url }}/${{ github.repository }})" >> $GITHUB_STEP_SUMMARY
          echo "- [Configuration File](${{ github.server_url }}/${{ github.repository }}/blob/${{ github.ref_name }}/wrangler.jsonc)" >> $GITHUB_STEP_SUMMARY
